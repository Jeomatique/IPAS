<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>IPAS - Indice de Potentialité d'Espaces Verts</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/proj4@2.9.1/dist/proj4.js"></script>
    <script src="https://unpkg.com/proj4leaflet@1.0.2/src/proj4leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sldreader@latest/dist/sldreader.js"></script>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: 'Segoe UI', Roboto, Arial, sans-serif; background-color: #f0f2f5; }
        .header-banner { height: 80px; background: linear-gradient(135deg, #4169E1 0%, #2a47a3 100%); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); position: relative; z-index: 1100; }
        .header-banner h1 { color: white; font-size: 1.2rem; text-align: center; margin: 0; padding: 0 100px; text-shadow: 1px 1px 3px rgba(0,0,0,0.3); }
        .header-logo { position: absolute; right: 20px; height: 50px; background: rgba(255,255,255,0.9); padding: 5px; border-radius: 5px; }
        #sidebar { position: absolute; top: 80px; bottom: 50px; left: 0; width: 340px; background-color: #f8f9fa; border-right: 1px solid #e0e0e0; z-index: 1050; padding: 20px; box-sizing: border-box; overflow-y: auto; text-align: justify; }
        .modern-box { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); opacity: 0.7; transition: all 0.3s ease; border: 1px solid transparent; }
        .modern-box:hover { opacity: 1; box-shadow: 0 8px 20px rgba(0,0,0,0.12); transform: translateY(-2px); }
        .layer-list-title { font-size: 1.1rem; color: #4169E1; font-weight: bold; margin: 20px 0 10px 5px; }
        .layer-item { padding: 12px 10px; border-bottom: 1px solid #eee; transition: all 0.2s ease; cursor: grab; border-radius: 8px; position: relative; }
        .layer-item:hover { background: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transform: scale(1.02); z-index: 5; }
        .layer-header { display: flex; align-items: center; justify-content: space-between; }
        .layer-header label { cursor: pointer; display: flex; align-items: center; gap: 10px; flex: 1; font-size: 0.9rem; }
        .layer-details { display: none; padding: 15px 5px 5px 30px; font-size: 0.85rem; color: #555; }
        .layer-details.active { display: block; }
        .opacity-slider-container { margin-bottom: 10px; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: #4169E1; }
        #map { position: absolute; top: 80px; bottom: 50px; left: 340px; right: 0; }
        .legend.modern-box { max-height: 250px; overflow-y: auto; background: rgba(255, 255, 255, 0.95); width: 220px; z-index: 1000; }
        .footer-banner { height: 50px; background: linear-gradient(to bottom, #f8f9fa, #e9ecef); position: absolute; bottom: 0; width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0 25px; box-sizing: border-box; border-top: 1px solid #d1d1d1; z-index: 1100; font-size: 0.7rem; color: #444; }
        .leaflet-control-coords { background: rgba(255,255,255,0.9); padding: 4px 8px; font-family: monospace; border-radius: 4px; border: 1px solid #ccc; margin-right: 10px !important; }
        .btn-blue { width: 100%; padding: 10px; background-color: #4169E1; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        #address-input { width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .arrow { font-size: 0.7rem; color: #aaa; transition: transform 0.3s; cursor: pointer; }
        .arrow.rotate { transform: rotate(180deg); color: #4169E1; }
    </style>
</head>
<body>

    <header class="header-banner">
        <h1>Indice de potentialité de Paris d'espaces verts pondéré à la distance et à la qualité d'espace disponible par personne.
        <span style="display:block;">Une disparité spatiale nord-Est versus Ouest-sud.</span>
        </h1>
        <img src="https://lptm.cyu.fr/medias/photo/cy-cergy-paris-universite-coul_1611572232688-png" alt="Logo CYU" class="header-logo">
    </header>

    <div id="sidebar">
        <div class="modern-box" style="margin-bottom: 30px;">
            <h3 style="margin-top:0; font-size: 0.95rem; color: #4169E1;">Recherche d'adresse</h3>
            <input type="text" id="address-input" placeholder="Ex: 10 rue de la Paix, Paris">
            <button class="btn-blue" onclick="searchAddress()">Chercher</button>
        </div>

        <div style="padding: 0 5px; margin-bottom: 30px;">
            <h3 style="margin-bottom: 8px; font-size: 1.1rem;">Résumé</h3>
            <p style="font-size: 0.9rem; line-height: 1.5; color: #555;">
              &nbsp;&nbsp;&nbsp;&nbsp;Notre composition cartographique présente l'IPAS ainsi que des cartes pour mettre en perspective une plausible corrélation entre l'IPAS avec le contraste socio-spatial Est-Ouest parisien.
            </p>
        </div>

        <div class="layer-list-title">Couches de données</div>
        <div id="layer-list-container"></div>
    </div>

    <div id="map"></div>

    <footer class="footer-banner">
        <div><strong>JOAQUIM Julian</strong> M1<br><strong>GIRARD Paul </strong> M1</div>
        <div style="text-align: center;">CY Cergy Paris Université <br> Master Géomatique appliqué aux études urbaines et aux risques<br>21.01.2026</div>
        <div style="text-align: right;"><strong>Source :</strong> (2022) IGN, INSEE, data iledefrance, opendata paris</div>
    </footer>

    <script>
        const lambert93 = new L.Proj.CRS('EPSG:2154', '+proj=lcc +lat_1=49 +lat_2=44 +lat_0=46.5 +lon_0=3 +x_0=700000 +y_0=6600000 +ellps=GRS80 +units=m +no_defs');
        const map = L.map('map', { attributionControl: true }).setView([48.857, 2.341], 12);

        const baseLayers = {
            "OpenStreetMap": L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(map),
            "ESRI Imagerie": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles © Esri' }),
            "ESRI Gris": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles © Esri' })
        };
        L.control.layers(baseLayers, null, { position: 'topright' }).addTo(map);

        let currentMarker = null;
        var marker = L.marker([48.85340407009002, 2.348788491757153]).addTo(map);
        marker.bindPopup("Point zero de Paris").openPopup();

        function updateMarker(latlng, label) {
            if (currentMarker) map.removeLayer(currentMarker);
            if (marker) map.removeLayer(marker);
            currentMarker = L.marker(latlng).addTo(map).bindPopup(label).openPopup();
        }

        map.on('click', function(e) {
            updateMarker(e.latlng, `Point sélectionné<br>Lat: ${e.latlng.lat.toFixed(4)}, Lon: ${e.latlng.lng.toFixed(4)}`);
        });

        function createGeoLayer(fileName) {
            const layer = L.geoJSON(null);
            const baseUrl = "https://raw.githubusercontent.com/Jeomatique/IPAS/main/root/";
            
            Promise.all([
                fetch(`${baseUrl}${fileName}.geojson`).then(r => r.json()),
                fetch(`${baseUrl}${fileName}.sld`).then(r => r.text())
            ]).then(([geoData, sldText]) => {
                const sldObject = SLDReader.Reader.readSLD(sldText);
                const styleInfo = SLDReader.Reader.getLayerStyle(sldObject);
                
                layer.addData(geoData);
                layer.setStyle((feature) => {
                    return SLDReader.LeafletLayer.getStyleFunction(styleInfo.symbolizers)(feature);
                });
            }).catch(err => console.error(`Erreur sur ${fileName}:`, err));
            
            return layer;
        }

        const overlaysData = [
            { name: "IPAS", legende: "IPAS (écart-type)", layer: createGeoLayer("IPAS"), description: "Indice de potentialité d’accès à un espace vert saturant." },
            { name: "Routes", legende: "Réseau routier", layer: createGeoLayer("routes"), description: "Réseau routier principal (IGN)." },
            { name: "Densité par quartiers", legende: "Densité (hab/km²)", layer: createGeoLayer("quartier_admin_densite"), description: "Densité de population par quartier administratif." },
            { name: "Parcs", legende: "Espaces verts", layer: createGeoLayer("parcs"), description: "Localisation des parcs et jardins publics." },
            { name: "Seine", legende: "La Seine", layer: createGeoLayer("Seine"), description: "Tracé de la Seine." },
            { name: "Revenus (IRIS)", legende: "Revenu médian", layer: createGeoLayer("IRIS_PARIS_revenu"), description: "Revenu disponible par unité de consommation." }
        ];

        L.control.scale({ position: 'bottomleft' }).addTo(map);
        
        const coords = L.control({ position: 'bottomright' });
        coords.onAdd = function() {
            this._div = L.DomUtil.create('div', 'leaflet-control-coords');
            map.on('mousemove', e => {
                const p = lambert93.project(e.latlng);
                this._div.innerHTML = `L93: ${p.x.toFixed(0)} m | ${p.y.toFixed(0)} m`;
            });
            return this._div;
        };
        coords.addTo(map);

        const legend = L.control({ position: 'bottomleft' });
        legend.onAdd = function() {
            this._div = L.DomUtil.create('div', 'legend modern-box');
            this.update();
            return this._div;
        };
        legend.update = function() {
            let content = "<strong>Légende</strong><hr style='border:0; border-top:1px solid #eee; margin:5px 0;'>";
            let hasL = false;
            overlaysData.forEach(o => {
                if(map.hasLayer(o.layer)) {
                    hasL = true;
                    content += `<div style='margin-bottom:8px;'><span style='display:inline-block; width:12px; height:12px; border:1px solid #999; background:#4169E1; margin-right:5px;'></span><strong>${o.legende}</strong></div>`;
                }
            });
            this._div.innerHTML = hasL ? content : "Aucune couche active";
        };
        legend.addTo(map);

        const listContainer = document.getElementById('layer-list-container');
        function renderLayers() {
            listContainer.innerHTML = '';
            overlaysData.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'layer-item';
                div.draggable = true;
                div.dataset.index = idx;
                div.innerHTML = `
                    <div class="layer-header">
                        <label>
                            <input type="checkbox" ${map.hasLayer(item.layer) ? 'checked' : ''} onchange="toggleLayer(${idx})">
                            ${item.name}
                        </label>
                        <span class="arrow" onclick="toggleAcc(${idx}, event)">▼</span>
                    </div>
                    <div id="acc-${idx}" class="layer-details" draggable="false" onmousedown="event.stopPropagation()">
                        <div class="opacity-slider-container">
                            <label style="font-size:0.75rem; color:#888; font-weight: bold;">Opacité</label>
                            <input type="range" min="0" max="1" step="0.1" value="0.7" oninput="changeOpacity(${idx}, this.value)">
                        </div>
                        <div style="line-height: 1.4; color: #444; margin-top: 10px; border-left: 2px solid #4169E1; padding-left: 10px;">
                            ${item.description}
                        </div>
                    </div>
                `;
                div.addEventListener('dragstart', (e) => { if (e.target.tagName === 'INPUT') return e.preventDefault(); div.classList.add('dragging'); });
                div.addEventListener('dragend', () => div.classList.remove('dragging'));
                div.addEventListener('dragover', e => e.preventDefault());
                div.addEventListener('drop', e => {
                    const dragging = document.querySelector('.dragging');
                    if (!dragging) return;
                    const dragIdx = Number(dragging.dataset.index);
                    const targetIdx = Number(div.dataset.index);
                    const moved = overlaysData.splice(dragIdx, 1)[0];
                    overlaysData.splice(targetIdx, 0, moved);
                    refreshLayers();
                });
                listContainer.appendChild(div);
            });
        }

        function toggleLayer(idx) {
            const l = overlaysData[idx].layer;
            map.hasLayer(l) ? map.removeLayer(l) : l.addTo(map);
            refreshLayers();
        }

        function changeOpacity(idx, val) {
            overlaysData[idx].layer.setStyle({ fillOpacity: val, opacity: val });
        }

        function toggleAcc(idx, e) {
            e.stopPropagation();
            document.getElementById(`acc-${idx}`).classList.toggle('active');
            e.target.classList.toggle('rotate');
        }

        function refreshLayers() {
            [...overlaysData].reverse().forEach((o, i) => {
                if(map.hasLayer(o.layer)) o.layer.bringToFront();
            });
            renderLayers();
            legend.update();
        }

        async function searchAddress() {
            const q = document.getElementById('address-input').value;
            if(!q) return;
            try {
                const r = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(q)}&limit=1`);
                const d = await r.json();
                if(d.features.length > 0) {
                    const c = d.features[0].geometry.coordinates;
                    const latlng = [c[1], c[0]];
                    map.setView(latlng, 16);
                    updateMarker(latlng, d.features[0].properties.label);
                }
            } catch (e) { console.error(e); }
        }

        overlaysData.find(o => o.name === "Seine").layer.addTo(map);
        refreshLayers();
    </script>
</body>
</html>